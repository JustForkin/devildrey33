<!-- 
    Test para el canvas del error 404 de devildrey33.es creado por Josep Antoni Bover Comas el 12-07-2016
    Idea original : http://es.gizmodo.com/la-mejor-pagina-de-error-404-te-deja-jugar-a-space-inva-510812213
        - En esencia me he basado en la imagen, ya que esa pagina de error ya no existe por desgracia (http://www.masswerk.at/404), aunque ahora tiene otra animación que también es muy chula.
        Vista por defecto en el Laboratorio de pruebas  
		devildrey33_Lab->Opciones->Vista = Filas;

        Ultima modificación el 15/08/2016

-->
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
        <!-- Estilos CSS para el test -->
        <style>
            body { background: rgb(49,46,53); margin:0px; padding:0px; }            
            #ContenedorSpaceInvaders404 { height:100vh; }
            /* Contenedor de las vidas y la puntuación */
            #ContenedorSpaceInvaders404 > div { position:absolute; height:30px; width:500px; left:calc(50% - 250px); top:calc(50% + 265px); }
            /* Marco para la energia de los disparos algo mas oscuro que el fondo */
            #ContenedorSpaceInvaders404 > div > #Disparos { position:absolute; height:18px; display:inline-block; width:100px; left:calc(50% - 50px); background:rgb(50, 50, 50); top:-4px; }
            /* Barra de energia para los disparos */
            #ContenedorSpaceInvaders404 > div > #Disparos > #Disparos_Valor { position:absolute; height:18px; display:inline-block; width:0px; left:0px; background:rgb(234, 80, 78);  }
            /* Puntuación */
            #ContenedorSpaceInvaders404 > div > #Puntuacion { position:absolute; height:30px; display:inline-block; right:0; top:-6px; color:rgb(234, 80, 78); font-weight:bold; font-size:18px; }
            /* Vidas */
            #ContenedorSpaceInvaders404 > div > span { display: inline-block; position:relative; width:30px; background:rgb(234, 80, 78); height:10px;  }
            #ContenedorSpaceInvaders404 > div > span::before { content:''; position:absolute; width:10px; background:rgb(234, 80, 78); height:10px; top:-6px; left:10px;  }
            /* Canvas */
            #SpaceInvaders404 { width:500px; height:500px; display:table; margin:auto; top:calc(50% - 250px); position:relative; border-bottom:3px solid rgb(234, 80, 78); /* border-top:1px solid rgb(234, 80, 78); */ /* cursor:none; */  }
            /* Información de la página 404 */
            #InfoSpaceInvaders404 { display:table; position:absolute; top:10px; left:50%; transform:translateX(-50%); }
            /* Titulo del error */
            #InfoSpaceInvaders404 > h1 { color:rgb(234, 80, 78); display:table; margin:10px auto; }
            /* Descripción del error 404 */
            #InfoSpaceInvaders404 > div:nth-child(2) { color:white; font-weight:bold; }
            #URLError404 { color: rgb(210, 210, 210); font-weight:normal; } 
            /* Instrucciones del juego*/
            #InfoSpaceInvaders404 > div:nth-child(3) { color:gray; margin-top:5px; }
            
            .SinSeleccion { -moz-user-select: none;  -webkit-user-select: none; -ms-user-select: none;  user-select: none; }
        </style>
        <!-- Si deseas utilizar JQuery descomenta la siguiente línea -->
<!--        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> -->
        <!-- ObjetoCanvas similar al ObjetoBanner para testear Banners -->
        <script src="/Web/JS/FuncionesGlobales.js"></script>
        <!-- Código javascript --> 
<script type="text/javascript">
"use strict";  
var RgbToHex = function(r, g, b) {
    this.Hex = function(c) {
        var h = c.toString(16);
        return (h.length === 1) ? "0" + h : h;
    };    
    return this.Hex(r) + this.Hex(g) + this.Hex(b);
};

var HexToRgb = function(h) {
    var hex = (h.charAt(0) === "#") ? h.substring(1, 7) : h;
/*    this.r = parseInt(hex.substring(0,2), 16);
    this.g = parseInt(hex.substring(2,4), 16);
    this.b = parseInt(hex.substring(4,6), 16);*/
    return { r : parseInt(hex.substring(0,2), 16), g : parseInt(hex.substring(2,4), 16), b : parseInt(hex.substring(4,6), 16) };
};

// Objeto que crea y contiene un canvas 2d para utilizarlo de back buffer
var BufferCanvas = function(Ancho, Alto) {
    this.Canvas = document.createElement("canvas");
    this.Canvas.setAttribute("width", Ancho);
    this.Canvas.setAttribute("height", Alto);
    this.Context = this.Canvas.getContext("2d"); 
};

// 
var SpaceInvaders404 = function() {
    this.ColorFondo     = "rgba(41,39,44, 1)";
    this.Canvas         = document.getElementById('SpaceInvaders404');
    this.Context        = this.Canvas.getContext("2d");                                             // Contexto 2D
    this.Ancho          = 500;
    this.Alto           = 500;
    this.Buffer404      = null;
    this.Mouse          = { X : 0, Y : 0 };
    // Imagen que contiene 3 tipos de enemigos con 2 caras, y el ovni
    this.PngEnemigos    = new Image();
    this.PngEnemigos.src = "data:image/png;base64,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";
                         /* Espacio     /\           A            D           <-          ->         */
    this.Teclado        = { 32 : false, 38 : false,  65 : false,  68 : false, 37 : false, 39 : false };
    this.Disparos       = [];   // Array de disparos 
    this.Enemigos       = [];   // Array de enemigos
    this.Estado         = 1;    // Estado del juego (0 inicio, 1 juego, 2 muerto, 3 terminado)
    this.Opciones       = { 
        HUD     : true,   // Ayuda visual con las barras de la X, Y del mouse, y el ángulo de disparo
        Tanque  : {      // Opciones para el tanque
            DisparosPorSegundo    : 5,  // Máximo de disparos por segundo
            MaxDisparosPorSegundo : 10, // Velocidad de desplazamiento de los disparos
            DisparosVelocidad     : 6, // Disparos por segundo actuales
            MaxVelocidad          : 5,  // Máximo de velocidad del tanque al moverse de derecha a izquierda
            Ancho                 : 30, // Ancho del tanque
            Alto                  : 10  // Alto de la base del tanque
        },
        Enemigo : {
            VelocidadX            : 1,    // Velocidad del enemigo al moverse de derecha a izquierda
            VelocidadY            : 4,    // Velocidad del enemigo al moverse hacia abajo
            MaxDisparosPorSegundo : 5,    // Máximo de disparos por segundo (de todos los enemigos)
            DisparosVelocidad     : 6,   // Velocidad de desplazamiento de los disparos
            MaxAnimacion          : 333,  // 500 ms para alternar la imagen
            AnimacionMS           : 0,    // Tiempo actual de la animación
            AnimacionCara         : false,// Cada enemigo tiene 2 imagenes (false/true)
            AniDerecha            : true, // Los enemigos van hacia la derecha
            EspacioAlto           : 30    // Espacio de alto que hay entre 2 enemigos
//            DisparosPorSegundo    : 3
        }
    };
    
    // Actualizo la URL para el texto de error
    document.getElementById("URLError404").innerHTML = window.location.href;

    // Función que crea un buffer con el texto 404
    this.CrearError404 = function() {
        // Creo un canvas que utilizare de back buffer para almacenar la imagen del 404, y asi poder almacenar los pixeles destruidos.
        this.Buffer404 = new BufferCanvas(this.Ancho, this.Alto);
        this.Buffer404.Context.font = "160px monospace";
        this.Buffer404.Context.fillStyle = "rgb(234, 80, 78)";
        this.Buffer404.Context.fillText("ERROR", (this.Ancho - this.Buffer404.Context.measureText("ERROR").width) / 2, 240); // La w suele tener un ancho aproximado a la altura del texto....
        this.Buffer404.Context.font = "260px monospace";
        this.Buffer404.Context.fillStyle = "rgb(234, 80, 78)";
        this.Buffer404.Context.fillText("404", (this.Ancho - this.Buffer404.Context.measureText("404").width) / 2, 440); // La w suele tener un ancho aproximado a la altura del texto....
        this.Buffer404.Context.strokeStyle = "rgba(41,39,44, 1)";
        // Con esta operación hacemos un clear encima del buffer 404 que todo lo que se pinta, borra el buffer con color transparente.
        this.Buffer404.Context.globalCompositeOperation = 'destination-out';
    };    

    this.TipoEnemigos = { // imgs de 60x30
        0 : { Ancho : 33, Alto : 24, X1 : 0,   X2 : 60 },
        1 : { Ancho : 24, Alto : 24, X1 : 120, X2 : 180 },
        2 : { Ancho : 36, Alto : 24, X1 : 240, X2 : 300 },
        3 : { Ancho : 48, Alto : 21, X1 : 360 } // ovni
    };

    // Estructura para los datos de un enemigo
    this.Enemigo = function(X, Y, Tipo) {
        this.X                  = X;
        this.Y                  = Y; 
        this.Tipo               = Tipo;
        this.DisparosPorSegundo = 0;
    };
    
    this.CrearEnemigos = function() {
        for (var y = 2; y > -1; y--) {
            for (var x = 0; x < 8; x++) {
                var Centro = 10 + Math.floor((40 - this.TipoEnemigos[y].Ancho) / 2);
                this.Enemigos.push(new this.Enemigo( Centro + (x * 40), this.Opciones.Enemigo.EspacioAlto * (y +1), y));
            }
        }
    };
    
        
    // Estructura para los datos del tanque del jugador
    this.JugadorTanque = function (Padre) {        
        this.X        = (Padre.Ancho - Padre.Opciones.Tanque.Ancho) / 2,
        this.Y        = Padre.Alto - 20;
        this.Angulo   = 90; // Ángulo de disparoqa
        this.Vel      = 0;  // Velocidad actual de desplazamiento
//        this.MuertoMS = 0;  // variable para la invulnerabilidad despues de morir
    };                 
       
    // Estructura para un disparo
    // Angulo 0 a 180 es hacia arriba (jugador) y de 180 a 360 es hacia abajo (enemigos)
    this.Disparo = function(X, Y, Angulo) {
        this.X          = X;
        this.Y          = Y; 
        this.Angulo     = Angulo;
        this.Distancia  = 1;
    };

    // Actualiza la posición del vehiculo 
    this.Teclado = function() {
        if (this.Opciones.Tanque.DisparosPorSegundo < this.Opciones.Tanque.MaxDisparosPorSegundo) {
            this.Opciones.Tanque.DisparosPorSegundo += this.Opciones.Tanque.MaxDisparosPorSegundo / 60;
        }
        // Barra que muestra el poder de disparo
        var Porcentaje = (100 / this.Opciones.Tanque.MaxDisparosPorSegundo) * this.Opciones.Tanque.DisparosPorSegundo;
        document.getElementById("Disparos_Valor").style.width = Porcentaje + "px";
        if (this.Teclado[65] === true || this.Teclado[37] === true) { 
            if (this.Tanque.Vel > -this.Opciones.Tanque.MaxVelocidad)  { this.Tanque.Vel -= 0.5; }
            if (this.Tanque.X > 0) { this.Tanque.X += this.Tanque.Vel; }
            else { this.Tanque.X = 0; }            
        } // A, <-
        else if (this.Teclado[68] === true || this.Teclado[39] === true) {  
            if (this.Tanque.Vel < this.Opciones.Tanque.MaxVelocidad)  { this.Tanque.Vel += 0.5; }
            if (this.Tanque.X < this.Ancho - this.Opciones.Tanque.Ancho) { this.Tanque.X += this.Tanque.Vel; }
            else { this.Tanque.X = this.Ancho - this.Opciones.Tanque.Ancho; }
        } // D, ->     
        // Al mover el tanque hay que recalcular el ángulo de disparo del tanque
        if (this.Teclado[65] === true || this.Teclado[37] === true || this.Teclado[68] === true || this.Teclado[39] === true) { 
            this.CalcularAnguloDisparoTanque();
        }
        
        if (this.Teclado[32] === true || this.Teclado[38] === true) {
            if (this.Opciones.Tanque.DisparosPorSegundo > 0) {
                this.Disparos.push(new this.Disparo(this.Tanque.X + (this.Opciones.Tanque.Ancho / 2), this.Tanque.Y - 12, this.Tanque.Angulo));
                this.Opciones.Tanque.DisparosPorSegundo --;
            }
        }        
    };
    
    /* Hace avanzar los disparos en su dirección, y detecta las colisiones*/
    this.ColisionesDisparos = function() {
        var Pixel = null;
        var Fondo = HexToRgb("#EA504E");
        this.Context.strokeStyle = "#FFFFFF";
        for (var i = this.Disparos.length - 1; i > -1; i--) {
            var s = Math.sin(this.Disparos[i].Angulo * (Math.PI / 180));
            var c = Math.cos(this.Disparos[i].Angulo * (Math.PI / 180));
            // Avanzo los disparos
            var ux = this.Disparos[i].X - (this.Disparos[i].Distancia * c);
            var uy = this.Disparos[i].Y - (this.Disparos[i].Distancia * s);
            this.Disparos[i].Distancia += this.Opciones.Tanque.DisparosVelocidad;
            var x = this.Disparos[i].X - (this.Disparos[i].Distancia  * c);
            var y = this.Disparos[i].Y - (this.Disparos[i].Distancia * s);
            Pixel = this.Context.getImageData(Math.floor(x), Math.floor(y), 1, 1);

            // Pinto el disparo en el buffer del 404
            this.Buffer404.Context.beginPath();
            this.Buffer404.Context.moveTo(this.Disparos[i].X, this.Disparos[i].Y);
            this.Buffer404.Context.lineTo(Math.floor(x), Math.floor(y));                
            this.Buffer404.Context.stroke();               
            // Colision
            if (Pixel.data[0] === Fondo.r && Pixel.data[1] === Fondo.g && Pixel.data[2] === Fondo.b) { 
                // Busco si ha impactado en un enemigo
                for (var e = this.Enemigos.length - 1; e > - 1; e--) {
                    if (this.Enemigos[e].X < x && this.Enemigos[e].X + this.TipoEnemigos[this.Enemigos[e].Tipo].Ancho > x &&
                        this.Enemigos[e].Y < y && this.Enemigos[e].Y + this.TipoEnemigos[this.Enemigos[e].Tipo].Alto > y) {
                        // Elimino el enemigo, ademas este es el sitio ideal para empezar una animación de explosión
                        this.Enemigos.splice(e, 1);  
                    }
                }
                // Busco si ha impactado en el jugador
                if (this.Tanque.X < x && this.Tanque.X + this.Opciones.Tanque.Ancho > x && this.Tanque.Y < y && this.Tanque.Y + this.Opciones.Tanque.Alto > y) {
                    this.MatarTanque();
                }
                
                this.Disparos.splice(i, 1);                                
            }
            // No hay colisión
            else {
                // Compruebo si se ha salido el disparo de la pantalla para eliminarlo
                if (x < 0 || x > this.Ancho || y < 0 || y > this.Alto) {
                    this.Disparos.splice(i, 1);
                }
                else {
                    // Pinto el disparo            
                    this.Context.beginPath();
                    this.Context.moveTo(ux, uy);
                    this.Context.lineTo(x, y);                
                    this.Context.stroke();
                }
            }
            
            
        }        
    };
    
    this.MatarTanque = function() { 
        
    };
    
    // Función que pinta el tanque y el HUD
    this.PintarTanque = function() {        
        // Pinto el HUD : 
        //  - una línea de izquerda a derecha con la posición X del mouse
        //  - una línea de arriba a abajo con la posición Y del mouse
        //  - línea desde el cañon del tanque a la posición x, y del mouse. 
        if (this.Opciones.HUD === true) {
            this.Context.strokeStyle = "#663333";
            var s = Math.sin(this.Tanque.Angulo * (Math.PI / 180));
            var c = Math.cos(this.Tanque.Angulo * (Math.PI / 180));
            // Ángulo de disparo
            this.Context.beginPath();
            this.Context.moveTo((this.Tanque.X + (this.Opciones.Tanque.Ancho / 2)) - c, (this.Tanque.Y - 12) - s);
            this.Context.lineTo(((this.Tanque.X + (this.Opciones.Tanque.Ancho / 2)) - (c * 1000)), ((this.Tanque.Y - 12) - (s * 1000)));                
            this.Context.stroke();
            this.Context.strokeStyle = "#663333";
            // Eje X
            this.Context.beginPath();
            this.Context.moveTo(0, this.Mouse.Y);
            this.Context.lineTo(this.Ancho, this.Mouse.Y);
            this.Context.stroke();
            // Eje Y
            this.Context.beginPath();
            this.Context.moveTo(this.Mouse.X, 0);
            this.Context.lineTo(this.Mouse.X, this.Alto);
            this.Context.stroke();
        }
        // Pinto el vehiculo del jugador
        this.Context.fillStyle = "rgb(234, 80, 78)"; 
        this.Context.fillRect(this.Tanque.X, this.Tanque.Y, this.Opciones.Tanque.Ancho, this.Opciones.Tanque.Alto);
        this.Context.fillRect(this.Tanque.X + this.Opciones.Tanque.Ancho / 3, this.Tanque.Y - 6, this.Opciones.Tanque.Ancho / 3, 16);
    };

    this.PintarEnemigos = function() {
        // Animación de la cara 
        this.Opciones.Enemigo.AnimacionMS += 16;
        if (this.Opciones.Enemigo.AnimacionMS > this.Opciones.Enemigo.MaxAnimacion) { 
            this.Opciones.Enemigo.AnimacionMS = 0;
            this.Opciones.Enemigo.AnimacionCara = !this.Opciones.Enemigo.AnimacionCara;
        }
        
        if (this.Enemigos.length === 0) { return; }
        // Guardo la posición del enemigo que está mas a la derecha
        var PosEnemigoDerecha = 0;
        var PosEnemigoIzquierda = this.Enemigos[0].X;
        for (var i = 0; i < this.Enemigos.length; i++) {
            if (this.Enemigos[i].X > PosEnemigoDerecha)   { PosEnemigoDerecha   = this.Enemigos[i].X; } 
            if (this.Enemigos[i].X < PosEnemigoIzquierda) { PosEnemigoIzquierda = this.Enemigos[i].X; } 
        }        

        // Compruebo si hay que alternar la dirección de los enemigos
        var AvanceY = 0;
        if (PosEnemigoIzquierda < 10)              { this.Opciones.Enemigo.AniDerecha = true;  AvanceY = this.Opciones.Enemigo.VelocidadY; }
        if (PosEnemigoDerecha > (this.Ancho - 50)) { this.Opciones.Enemigo.AniDerecha = false; AvanceY = this.Opciones.Enemigo.VelocidadY; }
                
        // Pinto los enemigos
        for (var i = 0; i < this.Enemigos.length; i++) {
            this.Enemigos[i].X = (this.Opciones.Enemigo.AniDerecha === true) ? this.Enemigos[i].X + this.Opciones.Enemigo.VelocidadX : this.Enemigos[i].X - this.Opciones.Enemigo.VelocidadX;
            this.Enemigos[i].Y += AvanceY;
            // Alterno la cara del enemigo
            var x = (this.Opciones.Enemigo.AnimacionCara === false) ? this.TipoEnemigos[this.Enemigos[i].Tipo].X1 : this.TipoEnemigos[this.Enemigos[i].Tipo].X2;
            // Pinto el enemigo en la pantalla
            this.Context.drawImage(this.PngEnemigos,    x,                                              0,                                              // coordenadas source
                                                        this.TipoEnemigos[this.Enemigos[i].Tipo].Ancho, this.TipoEnemigos[this.Enemigos[i].Tipo].Alto,  // tam source
                                                        this.Enemigos[i].X,                             this.Enemigos[i].Y,                             // coordenadas dest
                                                        this.TipoEnemigos[this.Enemigos[i].Tipo].Ancho, this.TipoEnemigos[this.Enemigos[i].Tipo].Alto); // tam dest
            // Pinto el enemigo en el buffer del 404
            this.Buffer404.Context.drawImage(this.PngEnemigos,  x,                                              0,                                              // coordenadas source
                                                                this.TipoEnemigos[this.Enemigos[i].Tipo].Ancho, this.TipoEnemigos[this.Enemigos[i].Tipo].Alto,  // tam source
                                                                this.Enemigos[i].X,                             this.Enemigos[i].Y,                             // coordenadas dest
                                                                this.TipoEnemigos[this.Enemigos[i].Tipo].Ancho, this.TipoEnemigos[this.Enemigos[i].Tipo].Alto); // tam dest
            // Sumo los nuevos disparos por segundo
            if (this.Enemigos[i].DisparosPorSegundo < this.Opciones.Enemigo.MaxDisparosPorSegundo) {
                this.Enemigos[i].DisparosPorSegundo += this.Opciones.Enemigo.MaxDisparosPorSegundo / 60;
            }
            // Si quedan disparos por segundo
            if (this.Enemigos[i].DisparosPorSegundo > 0) {
                this.Enemigos[i].DisparosPorSegundo --;   
//                if (this.BuscarEnemigo(this.Enemigos[i].X, this.Enemigos[i].Y + this.Opciones.Enemigo.EspacioAlto) === null) {
                    var Angulo = Math.atan2(this.Enemigos[i].Y - (this.Tanque.Y - 12), (this.Enemigos[i].X + (this.TipoEnemigos[this.Enemigos[i].Tipo].Ancho / 2)) - (this.Tanque.X + (this.Opciones.Tanque.Ancho / 2))) * 180 / Math.PI;
                    Angulo += Rand(2, -2);
                    this.Disparos.push(new this.Disparo(Math.floor(this.Enemigos[i].X + (this.TipoEnemigos[this.Enemigos[i].Tipo].Ancho / 2)), Math.floor(this.Enemigos[i].Y + (this.TipoEnemigos[this.Enemigos[i].Tipo].Alto)) , Angulo));
//                }
            }
        }        
    };

    this.BuscarEnemigo = function(x, y) {
        for (var i = this.Enemigos.length -1; i > -1; i--) {
            if (this.Enemigos[i].X > x && this.Enemigos[i].X < x + this.TipoEnemigos[this.Enemigos[i].Tipo].Ancho &&  this.Enemigos[i].Y === y) { 
                return this.Enemigos[i]; 
            }
        }
        return null;
    };

    this.CalcularAnguloDisparoTanque = function() {
        var Medio = { X : this.Tanque.X + (this.Opciones.Tanque.Ancho / 2),  Y : this.Tanque.Y - 12 };
        this.Tanque.Angulo = Math.atan2(Medio.Y - this.Mouse.Y, Medio.X - this.Mouse.X) * 180 / Math.PI;               
    };

    this.Actualizar = function() {
        // Borro el canvas
        this.Context.fillStyle = this.ColorFondo;
        this.Context.clearRect(0, 0, this.Ancho, this.Alto);
        if (this.Estado === 0) { // inicio
            // CanvasBuffer que contiene el texto 404 pintado
            this.Context.drawImage(this.Buffer404.Canvas, 0 ,0);                        
        }
        else if (this.Estado === 1) {
            // Compruebo las teclas presionadas
            this.Teclado();        

            // Primera capa : tanque y el hud para el mouse que indica el ángulo de disparo.
            this.PintarTanque();

            // Segunda capa : CanvasBuffer que contiene el texto 404 pintado
            this.Context.drawImage(this.Buffer404.Canvas, 0 ,0);

            // Tercera capa : enemigos
            this.PintarEnemigos();

            // Cuarta capa : disparos 
            // - compruebo las colisiones (contra el muro, los enemigos, y el jugador)
            this.ColisionesDisparos();
        }
        // Temporizador para el siguiente frame
        this.RAFID = window.requestAnimationFrame(this.Actualizar.bind(this)); 
    };
        
    this.EventoTeclaPresionada = function(Evento) {
        this.Teclado[Evento.keyCode] = true;
    };
    
    this.EventoTeclaSoltada = function(Evento) {
        this.Teclado[Evento.keyCode] = false;
        // 'A' 'D' '<-' '->'
        if (Evento.keyCode === 65 || Evento.keyCode === 68 || Evento.keyCode === 37 || Evento.keyCode === 39 ) { 
            this.Tanque.Vel = 0;
        }
    };
    
    this.EventoMouseMove = function(Evento) {       
        this.Mouse = { X : Evento.clientX - this.Canvas.offsetLeft,  Y : Evento.clientY - this.Canvas.offsetTop };
        // Tope para el mouse
        if (this.Mouse.Y > this.Alto - 32) { this.Mouse.Y = this.Alto - 32; }
        if (this.Mouse.Y < 0) { this.Mouse.Y = 0; }
        if (this.Mouse.X > this.Ancho) { this.Mouse.X = this.Ancho; }
        if (this.Mouse.X < 0) { this.Mouse.X = 0; }
        this.CalcularAnguloDisparoTanque();
//        console.log(this.Mouse, this.Tanque.Angulo);
    };

    this.EventoMouseDown = function(Evento) {
        this.Teclado[32] = true;
    };
    
    this.EventoMouseUp = function(Evento) {
        this.Teclado[32] = false;    
    };
        
    this.CrearError404();
    this.CrearEnemigos();
        
    // Creo la estructura con los datos del tanque del jugador
    this.Tanque = new this.JugadorTanque(this);
    
    // Enlazar eventos
    window.addEventListener('keydown', this.EventoTeclaPresionada.bind(this));
    window.addEventListener('keyup', this.EventoTeclaSoltada.bind(this));
    window.addEventListener('mousemove', this.EventoMouseMove.bind(this));
    window.addEventListener('mousedown', this.EventoMouseDown.bind(this));
    window.addEventListener('mouseup', this.EventoMouseUp.bind(this));

    window.focus();
    
    
    this.RAFID = window.requestAnimationFrame(this.Actualizar.bind(this)); 
    
};


var Error404 = null;
window.addEventListener('load', function() { Error404 = new SpaceInvaders404; });
</script>
    </head>
    <body>
        <div id='InfoSpaceInvaders404'  class="SinSeleccion">
            <h1>NO SE HA ENCONTRADO</h1>
            <div>La página : '<code id='URLError404'></code>' <u>no existe!</u></div>
        </div>
        <div id="ContenedorSpaceInvaders404"  class="SinSeleccion">
            <canvas id="SpaceInvaders404" width="500" height="500"></canvas>
            <div>
                <span></span>
                <span></span>
                <span></span>                
                <div id='Disparos'><div id='Disparos_Valor'></div></div>
                <div id='Puntuacion'>Puntuación : 0</div>
            </div>
        </div>
    </body>
</html>