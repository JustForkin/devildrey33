<!-- 
    Test para el banner 3d de devildrey33.es creado por Josep Antoni Bover Comas el 31-07-2016
        - Consiste en 2 cilindros cada uno con una textura translucida, en los que las texturas avanzan hacia adelante simulando un agujero de gusano.
	- Se utiliza JQuery y Three.js

	Vista por defecto en el Laboratorio de pruebas  
		devildrey33_Lab->Opciones->Vista = Preview;

        Ultima modificación el 03/08/2016
-->
<!DOCTYPE html>
<html>
    <head>
        <!-- Estilos CSS -->
<style type="text/css">
body { margin:0px; padding:0px; }
            
/* Estilos para los marcos informativos */
.Blog > #Cabecera {
    margin:0px;
    height:100%;
    border-top:none;
    color:#FFFFFF;
    background:rgba(49,46,53, 1);
    z-index:10;
    position:absolute;
    width:100%;
    overflow:hidden;
}        

.Blog > #Cabecera > #Cabecera_Canvas {
    width:100%;
    height:100%;
}
            
.Blog > #Cabecera > #Cabecera_Cargando,
.Blog > #Cabecera > #Cabecera_Stats {
    transition:0.3s cubic-bezier(.33,.05,.69,1.59);
    z-index:13;
    padding:10px;
    margin:5px;    
    background-color: rgba(37,35,40, 0.6);
    color:#FFF;
    text-shadow:1px 1px 1px #000;
    position:absolute;
    border:1px solid #353338;
}

.Blog > #Cabecera > #Cabecera_Cargando {
    top:0px;
    left:50%;
    transform:perspective(600px) rotateX(-90deg) translateX(-50%);
}        
            
.Blog > #Cabecera > #Cabecera_Stats {
    transform-origin: top center;
    transform:perspective(600px) rotateX(-90deg);  
    right:0px;
}
         
/* Solo se muestra la información de la animación si la animación está activa (puede estar visible pero inactiva si la web no tiene el foco) */
.Blog > #Cabecera[animar=true]:hover > #Cabecera_Stats {
    transform:perspective(600px) rotateX(0deg);    
}
/* Solo se muestra el texto cargando mientras el atributo cargando sea true (necesario para advertir de la carga de texturas) */
.Blog > #Cabecera[cargando=true] > #Cabecera_Cargando {
    transform:perspective(600px) rotateX(0deg) translateX(-50%);        
}

</style>
        
        <!-- Si deseas utilizar JQuery descomenta la siguiente línea -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

        <!-- Si deseas utilizar Three 3D lib descomenta la siguiente línea -->
        <script src="/Web/JS/3rdParty/three-0.79.min.js"></script>

        <!-- Código javascript --> 
<script type="text/javascript">
WormHole = function(Tipo) {
    this.Canvas = document.getElementById("Cabecera_Canvas");

    // Asigno el estado cargando, que muestra una ventana que avisa al usuario.
    $("#Cabecera").attr({ "cargando" : true, "animar" : true });
    
    try {
        this.Context = new THREE.WebGLRenderer({ canvas : this.Canvas });    // Contexto THREE.JS
        this.Context.setClearColor(0x312E35, 1);    // Color del fondo
    }
    catch ( error ) {
        alert(error, "Error creando el Banner");
    }

    this.Ancho          = 0;                                                // Ancho del canvas
    this.Alto           = 0;                                                // Altura del canvas
    this.RAFID          = 0;                                                // Request Animation Frame ID
    this.FPS_UltimoTick = Date.now() + 1000;                                // Ultimo Tick del sistema + 1000ms
    this.FPS_Contador   = 0;                                                // Contador de frames por segundo    
    this.FocoWeb        = false;                                            // Foco de la ventana de la web
    
    
    $("#Cabecera").on("mousemove", function(event) { 
        if ($Banner !== null) {
            $Banner.EventoMouseMove(event.clientX, event.clientY);
        }
    });    
    
    // Función que determina el estado de carga (cargando/completo) true/false
    this.Cargando = function(carga) {
        $("#Cabecera").attr({ "cargando" : carga });
    };

    this.Actualizar = function() {
        if ($Banner !== null) {
            $Banner.FPS(); 
            $Banner.RAFID = window.requestAnimationFrame($Banner.Actualizar);
            $Banner.Pintar(); 
        }
    };

    // Función que procesa el evento mousemove
    this.EventoMouseMove = function(X, Y) {
        if (typeof(this.MouseMove) !== "undefined") {
            this.MouseMove.apply(this, [X, Y]);
        }
    };

    // Función que obtiene el tamaño del canvas una vez redimensionado.
    this.EventoRedimensionar = function() {
        /* El ancho del canvas siempre tiene que ser el mismo que #MarcoNavegacion - 60 pixeles que ocupan los botones de la izquierda
         * La altura del canvas siempre es la misma desde el principio */
        this.Ancho  = document.getElementById("Cabecera").offsetWidth; 
        this.Alto   = document.getElementById("Cabecera").offsetHeight;
        this.Context.setSize(this.Ancho, this.Alto);
        if (this.Camara !== null && typeof(this.Camara) !== 'undefined') { // Si hay una camara creada
            this.Camara.aspect = this.Ancho / this.Alto;
            this.Camara.updateProjectionMatrix();            
        }
    };
    
    
    // Función que cuenta los frames por segundo
    this.FPS = function() {
        var Tick = Date.now();
        if (Tick > this.FPS_UltimoTick) {
            this.FPS_UltimoTick = Tick + 1000;
            $("#Cabecera_Stats").html(this.FPS_Contador + " FPS");
            this.FPS_Contador = 0;
        }
        else {
            this.FPS_Contador ++;
        }
    };
    ////////////////////////////////////////////////////////////////////////////////////////////  
    
    // Función que inicia los parámetros para este baner concreto
    this.IniciarBanner = function() {
        this.Escena = new THREE.Scene();

        this.Camara = new THREE.PerspectiveCamera(75, this.Ancho / this.Alto, 0.5, 1000);
        this.Camara.position.set( 0, 0, 500 );
        this.Escena.add(this.Camara);
        this.H = 0;
        this.H2 = 0.05;
        this.H3 = 0.1;

        this.TexturasCargadas = 0;
        this.TotalTexturas = 2;

        var LoaderT1 = new THREE.TextureLoader().load('/Web/Graficos/Banner_WormHole11.jpg', function(T) { 
            T.wrapT = T.wrapS = THREE.RepeatWrapping;
            T.repeat.set( 1, 2 );
            $Banner.Tunel = new THREE.Mesh(
                new THREE.CylinderGeometry( 50, 50, 1000, 16, 32, true ),
                new THREE.MeshBasicMaterial({ 
                    color: 0x666666,
                    transparent: true,
                    alphaMap: T,
                    side: THREE.BackSide,
                    opacity:0.3
                })
            );
            $Banner.Tunel.rotation.x = 90 * (Math.PI / 180); // 45 grados
            $Banner.Tunel.position.z = 128;        
            $Banner.Escena.add($Banner.Tunel);
            $Banner.Textura = T;
            console.log(T);

            $Banner.TexturasCargadas ++;
            // La textura se ha cargado, retiro la ventana que avisa al usuario de la carga.
            if ($Banner.TexturasCargadas === $Banner.TotalTexturas) { $Banner.Cargando(false); }
        });

        var LoaderT2 = new THREE.TextureLoader().load('/Web/Graficos/Banner_WormHole1.2.jpg', function(T2) { 
            T2.wrapT = T2.wrapS = THREE.RepeatWrapping;
            T2.repeat.set( 1, 2 );
            $Banner.Tunel2 = new THREE.Mesh(
                new THREE.CylinderGeometry( 60, 60, 1000, 16, 32, true ),
                new THREE.MeshBasicMaterial({ 
                    color: 0x666666,
                    transparent: true,
                    alphaMap: T2,
                    side: THREE.BackSide,
                    opacity:0.8
                })
            );
            $Banner.Tunel2.rotation.x = 90 * (Math.PI / 180); // 45 grados
            $Banner.Tunel2.position.z = 127;        
            $Banner.Escena.add($Banner.Tunel2);
            $Banner.Textura2 = T2;
            $Banner.TexturasCargadas ++;                       
            
            // La textura se ha cargado, retiro la ventana que avisa al usuario de la carga.
            if ($Banner.TexturasCargadas === $Banner.TotalTexturas) { $Banner.Cargando(false); }
        });

       /* var LoaderT3 = new THREE.TextureLoader().load('/Web/Graficos/Banner_WormHole1.2.jpg', function(T3) { 
            T3.wrapT = T3.wrapS = THREE.RepeatWrapping;
            T3.repeat.set( 1, 2 );
            $Banner.Tunel3 = new THREE.Mesh(
                new THREE.CylinderGeometry( 70, 70, 1000, 16, 32, true ),
                new THREE.MeshBasicMaterial({ 
                    color: 0x666666,
                    transparent: true,
                    alphaMap: T3,
                    side: THREE.BackSide,
                })
            );
            $Banner.Tunel3.rotation.x = 90 * (Math.PI / 180); // 45 grados
            $Banner.Tunel3.position.z = 126;        
            $Banner.Escena.add($Banner.Tunel3);
            $Banner.Textura3 = T3;
            $Banner.Textura3.offset.y = 0.5;
            $Banner.TexturasCargadas ++;
            // La textura se ha cargado, retiro la ventana que avisa al usuario de la carga.
            if ($Banner.TexturasCargadas === $Banner.TotalTexturas) { $Banner.Cargando(false); }
        });*/

        this.Camara.lookAt(this.Escena.position);        
    };
    
    this.Pintar = function() {
        if (typeof(this.Tunel) !== 'undefined') {
            this.H += 0.001;
            if (this.H > 1) { this.H = 0; }
            this.Tunel.material.color.setHSL(this.H, 0.7, 0.7);

            // Rotación del tunel
            this.Tunel.rotation.y += 0.02;
            // Textura infinita avanzando
            this.Textura.offset.y -= 0.014;
        }

        if (typeof(this.Tunel2) !== 'undefined') {
            // Color del tunel
            this.H2 += 0.001;
            if (this.H2 > 1) { this.H2 = 0; }
            this.Tunel2.material.color.setHSL(this.H2, 0.7, 0.7);

            // Rotación del tunel
            this.Tunel2.rotation.y -= 0.017;
            // Textura infinita avanzando
            this.Textura2.offset.y -= 0.019;
        }        
        
        if (typeof(this.Tunel3) !== 'undefined') {
            // Color del tunel
            this.H3 += 0.001;
            if (this.H3 > 1) { this.H3 = 0; }
            this.Tunel3.material.color.setHSL(this.H3, 0.7, 0.7);

            // Rotación del tunel
            this.Tunel3.rotation.y += 0.015;
            // Textura infinita avanzando
            this.Textura3.offset.y -= 0.016;
            
        }
        
        this.Context.render(this.Escena, this.Camara);        
    };
      
      
      
    this.EventoRedimensionar();
    this.IniciarBanner();
    this.RAFID = window.requestAnimationFrame(this.Actualizar);       

};

var $Banner = null;

$(window).on("load", function() { $Banner = new WormHole(); });


// Evento cambio de tamaño
$(window).on("resize", function() { 
    if ($Banner !== null) { $Banner.EventoRedimensionar(); }
});


// Evento posición scroll
$(window).on("scroll", function() { 
    if ($Banner !== null) { $Banner.EventoScroll(); }
});

</script>
    </head>
    <body>                
        <article class='Blog'>
            <header id='Cabecera'>
                <div id="Cabecera_Cargando">Cargando animación...</div>
                <div id='Cabecera_Stats'>60 FPS</div>
                <canvas id='Cabecera_Canvas'></canvas>
            </header>
        </article>
    </body>
</html>